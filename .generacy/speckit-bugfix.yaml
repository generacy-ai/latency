# Speckit Bugfix Workflow
#
# Streamlined bugfix workflow using the speckit methodology:
# specify → plan → tasks → implement → commit → verify → PR
#
# Skips clarification for faster bug resolution.
#
# Inputs:
#   - description: Bug description text (required)
#   - issue_url: GitHub issue URL for bug context (optional)
#   - short_name: Branch short name override (optional)
#
name: speckit-bugfix

description: |
  Streamlined bugfix workflow following spec-driven development.
  Creates a feature branch, generates specification, plans the fix,
  generates tasks, and executes implementation. Skips clarification
  for faster turnaround on bug fixes.

version: "1.0.0"

inputs:
  - name: description
    description: Bug description used to generate spec content
    type: string
    required: true

  - name: issue_url
    description: GitHub issue URL for additional context
    type: string
    required: false

  - name: issue_number
    description: GitHub issue number to use as feature number
    type: number
    required: false

  - name: short_name
    description: Optional short name for the feature branch
    type: string
    required: false

phases:
  # Phase 1: Setup
  - name: setup
    steps:
      - name: create-feature
        uses: speckit.create_feature
        with:
          description: ${{ inputs.description }}
          short_name: ${{ inputs.short_name }}
          number: ${{ inputs.issue_number }}

  # Phase 2: Specification
  - name: specification
    steps:
      - name: specify
        uses: speckit.specify
        timeout: 1800000  # 30 minutes (executor-level, in ms)
        with:
          feature_dir: ${{ steps.create-feature.output.feature_dir }}
          issue_url: ${{ inputs.issue_url }}
          timeout: 1800  # claude CLI timeout (in seconds)

  # Phase 3: Planning
  - name: planning
    steps:
      - name: plan
        uses: speckit.plan
        timeout: 1800000  # 30 minutes (executor-level, in ms)
        with:
          feature_dir: ${{ steps.create-feature.output.feature_dir }}
          timeout: 1800  # claude CLI timeout (in seconds)

  # Phase 4: Task Generation
  - name: task-generation
    steps:
      - name: tasks
        uses: speckit.tasks
        timeout: 1800000  # 30 minutes (executor-level, in ms)
        with:
          feature_dir: ${{ steps.create-feature.output.feature_dir }}
          timeout: 1800  # claude CLI timeout (in seconds)

  # Phase 5: Implementation
  - name: implementation
    steps:
      - name: implement
        uses: speckit.implement
        timeout: 3600000  # 1 hour max (executor-level, in ms)
        with:
          feature_dir: ${{ steps.create-feature.output.feature_dir }}

  # Phase 6: Commit & Push
  - name: commit-push
    steps:
      - name: git-add-commit
        uses: shell
        command: 'git add -A && git commit -m "fix: ${{ inputs.description }}" --no-verify'
        timeout: 30000

      - name: git-push
        uses: shell
        command: git push -u origin HEAD
        timeout: 60000

  # Phase 7: Verification
  - name: verification
    steps:
      - name: run-tests
        uses: verification.check
        with:
          command: npm test
        continueOnError: true

      - name: run-lint
        uses: verification.check
        with:
          command: npm run lint
        continueOnError: true

  # Phase 8: PR Creation
  - name: pr-creation
    steps:
      - name: create-pr
        uses: pr.create
        with:
          title: "fix: ${{ inputs.description }}"
          body: |
            ## Summary
            ${{ steps.specify.output.summary }}

            ## Fix
            - Files modified: ${{ steps.implement.output.files_modified }}

            ---
            Generated by speckit-bugfix workflow
          draft: true
